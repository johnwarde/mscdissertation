<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
<head>
<title>Login</title>
<link rel="stylesheet" th:href="@{/css/bootstrap.min.css}"
	href="../../css/bootstrap.min.css" />
</head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

<script th:inline="javascript">

var timeOut = 500;
var timeStart;

$(document).ready(function() {
	$("#effect").change(function(){
		//Need to encode the perod in filename otherwise we get a HTTP 406 error.
		var effectName = $(this).val();
		var imageName = $("#imagename").val().replace('.','[DOT]');
		var requestUri = '/effectrequest/' + effectName + '/' + imageName;
	    $.ajax({
	        url: /*[+   [[${hostname}]] + requestUri  +]*/
	    }).then(function(data) {
	        timeStart = new Date();
	       $("#requestidentider").val(data.requestId);
	       var timeNow = new Date();
	       var milliseconds = timeNow.getTime() - timeStart.getTime();
	       var msg = 'Request submitted, ' + milliseconds + ' milliseconds elapsed.';
	       $("#msgbox").text(msg);
	       // TODO: disable selection box and save button
	       setTimeout("checkRequest();", timeOut);
	    });
	});
});


function checkRequest(){
	var requestId = $("#requestidentider").val();
	var requestUri = '/effectfetch/' + requestId;
    $.ajax({
        url: /*[+   [[${hostname}]] + requestUri  +]*/
    }).then(function(data) {
       switch(data.status) {
	       case 'completed':
		       var timeNow = new Date();
		       var milliseconds = timeNow.getTime() - timeStart.getTime();
		       var msg = 'Processing <strong>complete</strong>, ' + milliseconds + ' milliseconds elapsed.';
		       $("#msgbox").html(msg);
	           $("#imagetag").attr("src", data.url);
	           // TODO: enable selection box and save button
	           break;
	       case 'notready':
		       var timeNow = new Date();
		       var milliseconds = timeNow.getTime() - timeStart.getTime();	    	   
		       var msg = 'Processing continuing, ' + milliseconds + ' milliseconds elapsed.';
		       $("#msgbox").text(msg);
	           setTimeout("checkRequest();", timeOut);
	           break;
	       default:
	    	   alert('Unknown error : ' + data.status);
   	   }
    });	
}


</script>
<body onload="document.form.imagename.focus();">
	<div class="container">
		<div th:replace="fragments/header :: header">...</div>	
		<div class="content">
			<h2>Image Effects</h2>
			<p id="msgbox" class="alert alert-info">Select an effect to apply to the image</p>
			<br/>
			<br/>
			<div class="pull-left">
				<div>
					<img id="imagetag" th:alt-title="${imagename}" th:src="${imagesWebPath + '/' + imageref}" />
				</div>
				<div>
					<h2 th:text="${imagename}">image name does here</h2>				
				</div>
			</div>
			<div class="pull-right">
				<form name="form" th:action="@{/image}" action="/image" method="POST">
					<fieldset>
						<input type="hidden" name="user" th:value="${user}" value="" />
						<input type="hidden" id="imagename" name="imagename" th:value="${imagename}" value="" />
						<input type="hidden" id="requestidentider" name="requestid" value="" />
						Effect :
						<select id="effect" name="effect">
							<option>Select</option>
							<option th:each="e : ${effects}" th:text="${e}"></option>
						</select>
					</fieldset>
					<input type="submit" id="save" value="Save" class="btn btn-primary" />
				</form>
			</div>
		</div>
	</div>
</body>
</html>